
import java.net.DatagramSocket;
import java.io.IOException;
import java.net.DatagramPacket;
import java.net.InetSocketAddress;
import java.net.SocketTimeoutException;

import tcdIO.*;

/**
 * @author slowinsj
 *
 */
public class Web_Proxy_Client extends Node
{
  static final String DEFAULT_DST_NODE = "localhost";
  static final int DEFAULT_SRC_PORT = 1000;
  static final int DEFAULT_DST_PORT = 4000;
  int client_no;
  Terminal terminal;
  InetSocketAddress dstAddress;
  /**
   * @param args
   */
  Web_Proxy_Client(Terminal terminal, int src_port) throws SocketTimeoutException {
    try
    {     
      client_no = src_port;
      this.terminal = terminal;
      socket = new DatagramSocket(src_port);
      listener.go();
    } catch (java.lang.Exception e)
    {
      e.printStackTrace();
    }

  }

  public void start() throws SocketTimeoutException
  {

    while (true)
    {
      DatagramPacket packet = null;

      byte[] payload = null;
      byte[] header = null;
      byte[] buffer = null;

      terminal.println("--------------------------------------------------------------------");
      payload = (terminal.readString("Website to access: ")).getBytes();
      header = new byte[PacketContent.HEADERLENGTH];
      header[0] = 
      header[1] = -1;
      dstAddress = new InetSocketAddress(DEFAULT_DST_NODE, DEFAULT_DST_PORT);
      buffer = new byte[header.length + payload.length];
      System.arraycopy(header, 0, buffer, 0, header.length);
      System.arraycopy(payload, 0, buffer, header.length, payload.length);

      terminal.println("Sending packet to port: " + DEFAULT_DST_PORT);
      packet = new DatagramPacket(buffer, buffer.length, dstAddress); 
      // send packet to dest
      try
      {
        socket.send(packet);
      } catch (IOException e)
      {
        // TODO Auto-generated catch block
        e.printStackTrace();
      }
      terminal.println("Message sent");
    }

  }

  public static void main(String[] args)
  {
    try 
    {
      Terminal terminal = new Terminal("Client");
      int client_no = terminal.readInt("Enter client number");
      (new Web_Proxy_Client(terminal, DEFAULT_SRC_PORT+client_no)).start();

      terminal.println("Program completed");
    }
    catch (java.lang.Exception e) 
    {
      e.printStackTrace();
}
  }

 
  public synchronized void onReceipt(DatagramPacket packet) 
  {
    StringContent content = new StringContent(packet);
    terminal.println("New message received: " + content.toString());
    terminal.println("--------------------------------------------------------------------");
    terminal.println();
   // terminal.println("Website to access: ");
    this.notify();
  }

}
